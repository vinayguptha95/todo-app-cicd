name: Parallel CI/CD Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'k8s/**'
      - '.github/workflows/parallel-ci-cd.yml'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'k8s/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: read
  security-events: read

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}

##########################################################
# BACKEND PIPELINE
##########################################################
jobs:
  backend:
    name: "ðŸ”§ Backend Pipeline"
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: "ðŸ“¦ Install Backend Dependencies"
        run: |
          cd backend
          npm ci

      - name: "ðŸ—ï¸ Build Backend"
        run: |
          cd backend
          npm run build || echo "No build script"

      - name: "ðŸ“¦ Upload Backend Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend/
          retention-days: 1

      - name: "ðŸ³ Setup Docker Buildx"
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: "ðŸ” Login to Azure Container Registry"
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: "ðŸ“¥ Restore Backend Artifact"
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend-restored

      - name: "ðŸ—ï¸ Build and Push Backend Docker Image"
        uses: docker/build-push-action@v5
        with:
          context: ./backend-restored/
          push: true
          platforms: linux/amd64
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/todo-backend:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/todo-backend:latest

      - name: "ðŸ” Trivy Scan Backend"
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: '${{ secrets.ACR_LOGIN_SERVER }}/todo-backend:${{ github.sha }}'
          format: sarif
          output: trivy-backend-results.sarif
          severity: HIGH,CRITICAL

##########################################################
# FRONTEND PIPELINE
##########################################################
  frontend:
    name: "ðŸŽ¨ Frontend Pipeline"
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: "ðŸ“¦ Install Frontend Dependencies"
        run: |
          cd frontend
          npm ci

      - name: "ðŸ—ï¸ Build Frontend"
        run: |
          cd frontend
          CI=false npm run build

      - name: "ðŸ“¦ Upload Frontend Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/
          retention-days: 1

      - name: "ðŸ³ Setup Docker Buildx"
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: "ðŸ” Login to ACR"
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: "ðŸ“¥ Restore Frontend Artifact"
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend-restored

      - name: "ðŸ—ï¸ Build and Push Frontend Image"
        uses: docker/build-push-action@v5
        with:
          context: ./frontend-restored/
          push: true
          platforms: linux/amd64
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/todo-frontend:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/todo-frontend:latest

      - name: "ðŸ” Trivy Scan Frontend"
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: '${{ secrets.ACR_LOGIN_SERVER }}/todo-frontend:${{ github.sha }}'
          format: sarif
          output: trivy-frontend-results.sarif
          severity: HIGH,CRITICAL

##########################################################
# DEPLOYMENT PIPELINE
##########################################################
  deploy:
    name: "ðŸš€ Deploy to AKS"
    needs: [backend, frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: "ðŸ“¥ Checkout Code"
        uses: actions/checkout@v4

      - name: "ðŸ” Azure Login"
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "âš™ï¸ Setup kubectl"
        uses: azure/setup-kubectl@v3

      - name: "ðŸ“‹ Get AKS Credentials"
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      - name: "ðŸ—„ï¸ Deploy MongoDB"
        run: |
          kubectl apply -f k8s/backend/mongodb.yaml
          kubectl rollout status deployment/mongodb --timeout=120s
    
      - name: "ðŸ—„ï¸ Deploy Backend Service"
        run: |
            kubectl apply -f k8s/backend/service.yaml
            kubectl get svc backend-service


      - name: "Install yq"
        run: |
            sudo wget https://github.com/mikefarah/yq/releases/download/v4.48.1/yq_linux_amd64 -O /usr/bin/yq
             sudo chmod +x /usr/bin/yq

      - name: "ðŸ”µðŸŸ¢ Blue-Green Backend Deployment"
        run: |
             # Detect current active color
               CURRENT_COLOR=$(kubectl get service backend-service -o jsonpath='{.spec.selector.color}' 2>/dev/null || echo blue)
                NEW_COLOR=$([ "$CURRENT_COLOR" = blue ] && echo green || echo blue)

                echo "Current color: $CURRENT_COLOR"
                echo "New color: $NEW_COLOR"

                # Update deployment for new color
                DEPLOYMENT_FILE="k8s/backend/deployment-$NEW_COLOR.yaml"
                yq e "(.spec.template.spec.containers[] | select(.name==\"backend\") | .image) = \"${{ secrets.ACR_LOGIN_SERVER }}/todo-backend:${{ github.sha }}\"" -i $DEPLOYMENT_FILE
                kubectl apply -f $DEPLOYMENT_FILE

                # Wait for rollout to finish
                kubectl rollout status deployment/backend-deployment-$NEW_COLOR --timeout=300s

                # Switch service to new color
                kubectl patch service backend-service -p "{\"spec\":{\"selector\":{\"color\":\"$NEW_COLOR\"}}}"

                 # Optionally scale down old color
                    OLD_COLOR=$([ "$NEW_COLOR" = blue ] && echo green || echo blue)
                 kubectl scale deployment backend-deployment-$OLD_COLOR --replicas=0 || true

      - name: "ðŸ”µðŸŸ¢ Blue-Green Frontend Deployment"
        run: |
              CURRENT_COLOR=$(kubectl get deployment frontend-deployment -o jsonpath='{.spec.template.metadata.labels.color}' 2>/dev/null || echo blue)
                 NEW_COLOR=$([ "$CURRENT_COLOR" = blue ] && echo green || echo blue)

               yq e ".spec.template.metadata.labels.color = \"$NEW_COLOR\"" -i k8s/frontend/deployment.yaml
               yq e "(.spec.template.spec.containers[] | select(.name==\"frontend\") | .image) = \"${{ secrets.ACR_LOGIN_SERVER }}/todo-frontend:${{ github.sha }}\"" -i k8s/frontend/deployment.yaml

                kubectl apply -f k8s/frontend/deployment.yaml
                 kubectl rollout status deployment/frontend-deployment --timeout=300s
                kubectl patch service frontend-service -p "{\"spec\":{\"selector\":{\"color\":\"$NEW_COLOR\"}}}"
