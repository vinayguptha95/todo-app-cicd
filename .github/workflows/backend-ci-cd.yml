name: Backend CI/CD Pipeline

on:
  push:
    branches: [dev-backend]
    paths:
      - 'backend/**'
      - 'k8s/backend/**'
      - '.github/workflows/backend-ci-cd.yml'
  pull_request:
    branches: [dev-backend]
    paths:
      - 'backend/**'

env:
  ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
  AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
  AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}

jobs:
  build-test-scan:
    name: "ðŸ”§ Build, Test & Scan Backend"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: "ðŸ“¥ Checkout code"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: "âš™ï¸ Setup Node.js"
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
        
    - name: "ðŸ“¦ Install dependencies"
      run: |
        cd backend
        npm ci
        
    - name: "ðŸ—ï¸ Build Backend"
      run: |
        cd backend
        npm run build || echo "No build script, continuing..."
        
    - name: "ðŸ§ª Run tests"
      run: |
        cd backend
        npm test || echo "Tests failed but continuing..."
        
    - name: "ðŸ“¦ Upload Build Artifacts"
      uses: actions/upload-artifact@v4
      with:
        name: backend-dev-build-${{ github.sha }}
        path: |
          backend/
          !backend/node_modules/
        retention-days: 7
        
    - name: "ðŸ³ Set up Docker Buildx"
      uses: docker/setup-buildx-action@v3
      
    - name: "ðŸ” Log in to Azure Container Registry"
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
        
    - name: "ðŸ“¥ Download Build Artifacts"
      uses: actions/download-artifact@v4
      with:
        name: backend-dev-build-${{ github.sha }}
        path: backend-build
        
    - name: "ðŸ—ï¸ Build and push Docker image"
      uses: docker/build-push-action@v5
      with:
        context: backend-build/backend
        push: ${{ github.event_name == 'push' }}
        tags: |
          ${{ secrets.ACR_LOGIN_SERVER }}/todo-backend:${{ github.sha }}
          ${{ secrets.ACR_LOGIN_SERVER }}/todo-backend:dev-latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: "ðŸ” Run Trivy vulnerability scanner"
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: '${{ secrets.ACR_LOGIN_SERVER }}/todo-backend:${{ github.sha }}'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: "ðŸ“¤ Upload Trivy scan results"
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        
  deploy-dev:
    name: "ðŸš€ Deploy to Dev Environment"
    needs: build-test-scan
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev-backend'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: "ðŸ“¥ Checkout code"
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: "âš™ï¸ Set up kubectl"
      uses: azure/setup-kubectl@v3
      
    - name: "ðŸ” Login to Azure"
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: "ðŸ“‹ Get AKS credentials"
      run: |
        az aks get-credentials \
          --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
          --name ${{ secrets.AKS_CLUSTER_NAME }} \
          --overwrite-existing
          
    - name: "ðŸ—„ï¸ Ensure MongoDB is running"
      run: |
        kubectl apply -f k8s/backend/mongodb.yaml --namespace=default
        
    - name: "ðŸ”„ Deploy Backend to Dev"
      run: |
        # Create dev namespace if it doesn't exist
        kubectl create namespace dev 2>/dev/null || true
        
        # Deploy backend to dev namespace
        cat k8s/backend/deployment.yaml | \
          sed "s|placeholder/backend:latest|${{ secrets.ACR_LOGIN_SERVER }}/todo-backend:${{ github.sha }}|g" | \
          sed "s|name: backend-deployment|name: backend-deployment-dev|g" | \
          kubectl apply -n dev -f -
        
        # Create dev service
        cat k8s/backend/service.yaml | \
          sed "s|name: backend-service|name: backend-service-dev|g" | \
          sed "s|type: ClusterIP|type: NodePort|g" | \
          kubectl apply -n dev -f -
        
        kubectl rollout status -n dev deployment/backend-deployment-dev --timeout=300s
        
    - name: "ðŸ“Š Get Dev Deployment Info"
      run: |
        echo "=== Dev Backend Deployment ==="
        kubectl get deployment -n dev backend-deployment-dev
        echo ""
        echo "=== Dev Backend Service ==="
        kubectl get service -n dev backend-service-dev
        echo ""
        echo "=== Dev Backend Pods ==="
        kubectl get pods -n dev -l app=backend
        
    - name: "ðŸ“ Deployment Summary"
      if: always()
      run: |
        NODE_PORT=$(kubectl get service -n dev backend-service-dev -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "Not available")
        echo "## ðŸš€ Backend Dev Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Access Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Namespace:** dev" >> $GITHUB_STEP_SUMMARY
        echo "- **Service:** backend-service-dev" >> $GITHUB_STEP_SUMMARY
        if [ "$NODE_PORT" != "Not available" ]; then
          echo "- **NodePort:** $NODE_PORT" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Verification" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        kubectl get pods -n dev 2>/dev/null >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY